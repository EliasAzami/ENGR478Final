/*
  @file    main.c
  @author  Milton
  @date    Fall-2025
 */

#include "stm32l476xx.h"
#include "ADC.h"
#include "PWM.h"
#include "LED.h"
#include "button.h"
#include "Systick_timer.h"
#include <stdint.h>

// 1: System active (PWM follows throttle + LED heartbeat)
// 0: System paused/disarmed (PWM neutral + LED off)
volatile uint8_t  system_active = 1;   // start ARMED (you can change to 0 if you want)
volatile uint8_t  system_arming = 0;   // 1 during arming delay
volatile uint32_t arming_ms     = 0;   // ms counter for arming state

int main(void){

    // 1. Initialize status LED (PA5, LD2)
    configure_LED_pin();
    turn_on_LED();       // Start with system "active" (LED will heartbeat)

    // 2. Initialize the user pushbutton and EXTI interrupt
    button_init();

    // 3. Initialize SysTick for 1 ms ticks (4 MHz / 4000 = 1 kHz)
    SysTick_Init(4000);

    // 4. Initialize ADC (0â€“3.3 V) on the throttle input
    ADC_Init();

    // 5. Initialize PWM (TIM2_CH1 on PA0) for ESC pulse output
    PWM_Init();

    // 6. Main control loop:
    //    - If system_active = 1: read throttle (ADC) and update PWM pulse width.
    //    - If system_active = 0: hold ESC at a "stopped" pulse.
    while (1) {

        if (system_active) {
            // System running:
            // 1) Read one 10-bit ADC sample (0..1023)
            uint16_t value = ADC_Read10bit();

            // 2) Map ADC value (0..1023) to pulse width 1000..2000 us
            //
            //    us = 1000 us + (value / 1023) * 1000 us
            //    Integer math: us = 1000 + (value * 1000) / 1023
            uint16_t us = 1000 + (value * 1000) / 1023;

            // 3) Update PWM output for ESC
            PWM_SetPulse_us(us);
        } 
        else {
            // System paused/disarmed:
            // Hold ESC at "stopped" pulse (here: 1000 us). Adjust if your ESC uses 1500 us neutral.
            PWM_SetPulse_us(1000);
        }
    }
}
